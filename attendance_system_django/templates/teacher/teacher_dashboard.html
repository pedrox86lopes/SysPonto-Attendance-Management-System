{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard do Formador | SysPonto{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#1f2937',
                    accent: '#3b82f6',
                    success: '#10b981',
                    warning: '#f59e0b',
                    danger: '#ef4444'
                }
            }
        }
    }
</script>
{% endblock extra_css %}

{% block content %}
<body class="bg-gray-50">
    <!-- Navigation Header -->
    <nav class="bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <i data-lucide="shield-check" class="h-8 w-8"></i>
                    <h1 class="text-xl font-bold">SysPonto - Professor</h1>
                </div>
                <div class="flex items-center space-x-6">
                    <!-- Notifications -->
                    <div class="relative">
                        <button class="text-white hover:text-gray-300 relative" id="notificationBtn">
                            <i data-lucide="bell" class="h-6 w-6"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full h-5 w-5 flex items-center justify-center" id="notificationCount">0</span>
                        </button>
                    </div>
                    <!-- Connection Status -->
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-success rounded-full" id="connectionStatus"></div>
                        <span class="text-sm">Conectado</span>
                    </div>
                    <!-- User Info -->
                    <div class="flex items-center space-x-2">
                        <i data-lucide="user" class="h-5 w-5"></i>
                        <span class="text-sm">{{ request.user.get_full_name|default:request.user.username }}</span>
                    </div>
                    <a href="{% url 'logout' %}" class="text-white hover:text-gray-300">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Welcome Section with Active Session -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Bem-vindo, Professor {{ request.user.get_full_name|default:request.user.username }}! üëã</h2>
                    <p class="text-gray-600">Fa√ßa a gest√£o das suas turmas e monitoriza a presen√ßa em tempo real.</p>
                </div>
                <!-- Active Session Indicator -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4" id="activeSessionIndicator" style="display: none;">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                        <div>
                            <p class="font-semibold text-green-800">Aula Ativa</p>
                            <p class="text-sm text-green-600" id="activeSessionName">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-accent">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Submiss√µes Pendentes</p>
                        <p class="text-2xl font-bold text-accent" id="pendingSubmissions">0</p>
                        <p class="text-sm text-gray-500">Aguardam valida√ß√£o</p>
                    </div>
                    <i data-lucide="users" class="h-8 w-8 text-accent"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-success">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Taxa de Presen√ßa Hoje</p>
                        <p class="text-2xl font-bold text-success" id="todayAttendanceRate">--%</p>
                        <p class="text-sm text-success" id="todayAttendanceText">-- alunos presentes</p>
                    </div>
                    <i data-lucide="trending-up" class="h-8 w-8 text-success"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-warning">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Aulas Hoje</p>
                        <p class="text-2xl font-bold text-warning" id="todaySessionCount">{{ teacher_class_sessions_today|length }}</p>
                        <p class="text-sm text-gray-500">{{ teacher_class_sessions_today|length }} sess√µes programadas</p>
                    </div>
                    <i data-lucide="calendar" class="h-8 w-8 text-warning"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">C√≥digos Ativos</p>
                        <p class="text-2xl font-bold text-purple-500" id="activeCodesCount">0</p>
                        <p class="text-sm text-gray-500">Em circula√ß√£o</p>
                    </div>
                    <i data-lucide="key" class="h-8 w-8 text-purple-500"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Main Controls -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Code Generation Section -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i data-lucide="key" class="h-5 w-5 mr-2 text-accent"></i>
                                Gerar C√≥digo de Presen√ßa
                            </h3>
                            <div class="flex items-center space-x-2" id="codeStatusIndicator">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                <span class="text-sm text-gray-500">Sem c√≥digo ativo</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <!-- Class Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Turma:</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" id="classSessionSelect">
                                {% for session in teacher_class_sessions_today %}
                                <option value="{{ session.id }}"
                                    data-course-name="{{ session.course.name }}"
                                    data-start-time="{{ session.start_time|time:'H:i' }}"
                                    data-end-time="{{ session.end_time|time:'H:i' }}"
                                    {% if active_class_session_for_display and session.id == active_class_session_for_display.id %}selected{% endif %}>
                                    {{ session.course.name }} - {{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}
                                </option>
                                {% empty %}
                                <option value="">N√£o h√° aulas hoje.</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Active Code Display -->
                        <div class="bg-gradient-to-r from-accent to-blue-600 rounded-lg p-6 text-white mb-4" id="activeCodeDisplay" style="display: none;">
                            <div class="text-center">
                                <p class="text-sm opacity-90 mb-2">C√≥digo Atual:</p>
                                <div class="flex items-center justify-center space-x-4">
                                    <p class="text-4xl font-mono font-bold tracking-widest" id="currentCode">------</p>
                                    <button class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg p-2 transition-colors" onclick="copyCodeToClipboard()">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                                <div class="mt-3 flex items-center justify-center space-x-4">
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="clock" class="h-4 w-4 mr-1"></i>
                                        <span id="timeRemaining">Expira em: --:--</span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="users" class="h-4 w-4 mr-1"></i>
                                        <span id="submissionCount">0 submiss√µes</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <button class="flex-1 bg-accent text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors" onclick="generateNewCode()" id="generateCodeBtn">
                                Gerar Novo C√≥digo
                            </button>
                            <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors" onclick="deactivateCode()" id="deactivateBtn" style="display: none;">
                                Desactivar
                            </button>
                            <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="validateAllPending()" id="validateAllBtn">
                                Validar Todas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Real-time Submissions -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i data-lucide="activity" class="h-5 w-5 mr-2 text-green-500"></i>
                                Submiss√µes em Tempo Real
                            </h3>
                            <div class="flex items-center space-x-3">
                                <button class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors" onclick="exportSubmissions()">
                                    <i data-lucide="download" class="h-4 w-4 mr-1 inline"></i>
                                    Exportar
                                </button>
                                <div class="text-sm text-gray-500" id="lastUpdated">Nunca atualizado</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <!-- Filters -->
                        <div class="flex space-x-2 mb-4">
                            <button class="px-3 py-1 bg-accent text-white rounded-full text-sm filter-btn active" data-filter="all">Todos (<span id="allCount">0</span>)</button>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 filter-btn" data-filter="pending">Pendentes (<span id="pendingCount">0</span>)</button>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 filter-btn" data-filter="validated">Validados (<span id="validatedCount">0</span>)</button>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 filter-btn" data-filter="suspicious">Suspeitos (<span id="suspiciousCount">0</span>)</button>
                        </div>

                        <!-- Submissions List -->
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="submissionsList">
                            <div class="text-center text-gray-500 py-8">
                                Selecione uma sess√£o para ver os envios.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Side Panels -->
            <div class="space-y-6">
                <!-- Today's Schedule -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="calendar-days" class="h-5 w-5 mr-2 text-accent"></i>
                            Hor√°rio de Hoje
                        </h3>
                    </div>
                    <div class="p-6 space-y-3" id="todayScheduleList">
                        {% for session in teacher_class_sessions_today %}
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold text-blue-800">{{ session.course.name }}</p>
                                    <p class="text-sm text-blue-600">{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Programada</span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-gray-500 py-4">
                            N√£o h√° aulas programadas para hoje.
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">A√ß√µes R√°pidas</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <button class="w-full flex items-center justify-center px-4 py-3 bg-accent text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="exportReport()">
                            <i data-lucide="file-spreadsheet" class="h-4 w-4 mr-2"></i>
                            Exportar Relat√≥rio
                        </button>
                        <a href="{% url 'teacher_dashboard' %}" class="w-full flex items-center justify-center px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                            <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                            An√°lise Detalhada
                        </a>
                        <button class="w-full flex items-center justify-center px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="sendNotification()">
                            <i data-lucide="message-circle" class="h-4 w-4 mr-2"></i>
                            Enviar Notifica√ß√£o
                        </button>
                        <button class="w-full flex items-center justify-center px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" onclick="openSettings()">
                            <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                            Configura√ß√µes
                        </button>
                    </div>
                </div>

                <!-- System Alerts -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="alert-circle" class="h-5 w-5 mr-2 text-red-500"></i>
                            Alertas do Sistema
                        </h3>
                    </div>
                    <div class="p-6 space-y-3" id="systemAlerts">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <i data-lucide="info" class="h-4 w-4 text-blue-500 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-blue-800 text-sm">Sistema Atualizado</p>
                                    <p class="text-xs text-blue-600">Todas as funcionalidades est√£o operacionais</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Django data injection -->
    <script id="django-data" type="application/json">
    {
        "initialCodeDetails": {{ initial_code_details_json|default:"{}"|safe }},
        "initialStudentSubmissions": {{ initial_student_submissions_json|default:"[]"|safe }},
        "activeClassSessionIdInitial": "{{ active_class_session_id_initial|default:""|safe }}",
        "userRole": "teacher",
        "csrfToken": "{{ csrf_token|safe }}",
        "isAuthenticated": {{ request.user.is_authenticated|yesno:"true,false" }},
        "apiUrls": {
            "generateCode": "{% url 'generate_code_api_view' %}",
            "runAiValidation": "{% url 'run_ai_validation' %}",
            "validateAttendance": "{% url 'validate_attendance' %}",
            "getSessionSubmissions": "{% url 'get_session_submissions' %}"
        }
    }
    </script>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Parse Django data safely
        let djangoData;
        try {
            djangoData = JSON.parse(document.getElementById('django-data').textContent);
        } catch (e) {
            console.error('Error parsing Django data:', e);
            djangoData = {
                initialCodeDetails: {},
                initialStudentSubmissions: [],
                activeClassSessionIdInitial: "",
                userRole: "teacher",
                csrfToken: "",
                isAuthenticated: false,
                apiUrls: {}
            };
        }
        
        // Global variables
        let attendanceSocket = null;
        let currentClassSessionId = null;
        let codeTimerInterval = null;
        let codeExpiryTimestamp = null;
        let currentSubmissions = [];
        let currentFilter = 'all';
        
        // Extract data from Django
        const initialCodeDetails = djangoData.initialCodeDetails || {};
        const initialStudentSubmissions = djangoData.initialStudentSubmissions || [];
        const activeClassSessionIdInitial = djangoData.activeClassSessionIdInitial || "";
        const CSRF_TOKEN = djangoData.csrfToken || "";
        const API_URLS = djangoData.apiUrls || {};

        // ===== MAIN FUNCTIONS =====
        
        function generateNewCode() {
            const sessionSelect = document.getElementById('classSessionSelect');
            const classSessionId = sessionSelect ? sessionSelect.value : '';

            if (!classSessionId) {
                alert('Selecione uma sess√£o de aula.');
                return;
            }

            const generateBtn = document.getElementById('generateCodeBtn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Gerando...';
            }

            fetch(API_URLS.generateCode, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: new URLSearchParams({
                    'class_session_id': classSessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateCodeDisplay(data.code, data.expires_at);
                    updateActiveSessionIndicator(sessionSelect.options[sessionSelect.selectedIndex].dataset.courseName);
                    alert('C√≥digo gerado com sucesso!');
                    initWebSocket(classSessionId);
                    loadSubmissionsForSession(classSessionId);
                } else {
                    alert('Erro ao gerar c√≥digo: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro de pesquisa:', error);
                alert('Ocorreu um erro ao gerar o c√≥digo.');
            })
            .finally(() => {
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Gerar Novo C√≥digo';
                }
            });
        }

        function updateCodeDisplay(code, expiresAtISO) {
            const codeDisplay = document.getElementById('currentCode');
            const activeCodeDisplay = document.getElementById('activeCodeDisplay');
            const statusIndicator = document.getElementById('codeStatusIndicator');
            const generateBtn = document.getElementById('generateCodeBtn');
            const deactivateBtn = document.getElementById('deactivateBtn');

            if (codeDisplay && activeCodeDisplay) {
                codeDisplay.textContent = code;
                activeCodeDisplay.style.display = 'block';
                
                if (statusIndicator) {
                    statusIndicator.innerHTML = `
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-green-600">C√≥digo ativo</span>
                    `;
                }
                
                if (generateBtn) generateBtn.textContent = 'Gerar Novo C√≥digo';
                if (deactivateBtn) deactivateBtn.style.display = 'inline-block';

                codeExpiryTimestamp = new Date(expiresAtISO).getTime();
                startCodeTimer();
                
                // Update active codes count
                document.getElementById('activeCodesCount').textContent = '1';
            }
        }

        function startCodeTimer() {
            if (codeTimerInterval) clearInterval(codeTimerInterval);

            codeTimerInterval = setInterval(function() {
                const now = new Date().getTime();
                const timeLeft = codeExpiryTimestamp - now;
                const timerElement = document.getElementById('timeRemaining');

                if (timeLeft <= 0) {
                    clearInterval(codeTimerInterval);
                    if (timerElement) timerElement.textContent = 'C√≥digo Expirado';
                    
                    const statusIndicator = document.getElementById('codeStatusIndicator');
                    if (statusIndicator) {
                        statusIndicator.innerHTML = `
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-red-600">C√≥digo expirado</span>
                        `;
                    }
                    document.getElementById('activeCodesCount').textContent = '0';
                    return;
                }

                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                if (timerElement) {
                    timerElement.textContent = 'Expira em: ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }
            }, 1000);
        }

        function copyCodeToClipboard() {
            const codeElement = document.getElementById('currentCode');
            if (codeElement) {
                navigator.clipboard.writeText(codeElement.textContent).then(() => {
                    alert('C√≥digo copiado para a √°rea de transfer√™ncia!');
                }).catch(err => {
                    console.error('Falha ao copiar:', err);
                });
            }
        }

        function deactivateCode() {
            const activeCodeDisplay = document.getElementById('activeCodeDisplay');
            const statusIndicator = document.getElementById('codeStatusIndicator');
            const deactivateBtn = document.getElementById('deactivateBtn');
            
            if (activeCodeDisplay) activeCodeDisplay.style.display = 'none';
            if (deactivateBtn) deactivateBtn.style.display = 'none';
            
            if (statusIndicator) {
                statusIndicator.innerHTML = `
                    <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">Sem c√≥digo ativo</span>
                `;
            }
            
            clearInterval(codeTimerInterval);
            document.getElementById('activeCodesCount').textContent = '0';
            
            if (attendanceSocket) {
                attendanceSocket.close();
            }
        }

        function updateActiveSessionIndicator(courseName) {
            const indicator = document.getElementById('activeSessionIndicator');
            const sessionName = document.getElementById('activeSessionName');
            
            if (indicator && sessionName) {
                sessionName.textContent = courseName;
                indicator.style.display = 'block';
            }
        }

        function loadSubmissionsForSession(sessionId) {
            const submissionsList = document.getElementById('submissionsList');
            if (!submissionsList) return;
            
            if (!API_URLS.getSessionSubmissions) {
                submissionsList.innerHTML = '<div class="text-center text-red-500 py-4">URL da API n√£o dispon√≠vel</div>';
                return;
            }

            submissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">Carregando envios...</div>';
            currentClassSessionId = sessionId;

            fetch(API_URLS.getSessionSubmissions + '?class_session_id=' + sessionId)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentSubmissions = data.submissions || [];
                    renderSubmissions();
                    updateSubmissionCounts();
                } else {
                    submissionsList.innerHTML = '<div class="text-center text-red-500 py-4">Erro ao carregar envios: ' + (data.message || 'Erro desconhecido') + '</div>';
                }
            })
            .catch(error => {
                console.error('Erro de pesquisa:', error);
                submissionsList.innerHTML = '<div class="text-center text-red-500 py-4">Falha ao pesquisar envios.</div>';
            });
        }

        function renderSubmissions() {
            const submissionsList = document.getElementById('submissionsList');
            if (!submissionsList) return;

            let filteredSubmissions = currentSubmissions;
            
            // Apply filter
            if (currentFilter !== 'all') {
                filteredSubmissions = currentSubmissions.filter(sub => {
                    switch(currentFilter) {
                        case 'pending': return !sub.is_present;
                        case 'validated': return sub.is_present;
                        case 'suspicious': return sub.aiResult && sub.aiResult.isFraudulent;
                        default: return true;
                    }
                });
            }

            if (filteredSubmissions.length === 0) {
                submissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhuma submiss√£o encontrada para este filtro.</div>';
                return;
            }

            submissionsList.innerHTML = '';
            
            filteredSubmissions.forEach(submission => {
                const submissionElement = createSubmissionElement(submission);
                submissionsList.appendChild(submissionElement);
            });
            
            // Update last updated time
            const lastUpdated = document.getElementById('lastUpdated');
            if (lastUpdated) {
                lastUpdated.textContent = 'Atualizado h√° ' + new Date().toLocaleTimeString('pt-PT');
            }
        }

        function createSubmissionElement(submission) {
            const div = document.createElement('div');
            
            let statusClass, statusText, borderClass, bgClass;
            
            if (submission.is_present) {
                statusClass = 'border-green-200 bg-green-50';
                statusText = 'Presente';
                borderClass = 'border-green-200';
                bgClass = 'bg-green-50';
            } else if (submission.aiResult && submission.aiResult.isFraudulent) {
                statusClass = 'border-red-200 bg-red-50';
                statusText = 'Suspeito';
                borderClass = 'border-red-200';
                bgClass = 'bg-red-50';
            } else {
                statusClass = 'border-yellow-200 bg-yellow-50';
                statusText = 'Pendente';
                borderClass = 'border-yellow-200';
                bgClass = 'bg-yellow-50';
            }

            div.className = `flex items-center justify-between p-4 border ${borderClass} ${bgClass} rounded-lg`;
            div.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center border">
                        <span class="font-semibold text-sm">${submission.name ? submission.name.substring(0, 2).toUpperCase() : 'UN'}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">${submission.name || 'Nome Desconhecido'}</p>
                        <p class="text-sm text-gray-500">Submetido h√° ${getTimeAgo(submission.timestamp)} ‚Ä¢ IP: ${submission.simulatedIp || '--'}</p>
                        ${submission.aiResult ? `<div class="flex items-center mt-1">
                            <i data-lucide="${submission.aiResult.isFraudulent ? 'alert-triangle' : 'shield-check'}" class="h-3 w-3 ${submission.aiResult.isFraudulent ? 'text-red-500' : 'text-green-500'} mr-1"></i>
                            <span class="text-xs ${submission.aiResult.isFraudulent ? 'text-red-600' : 'text-green-600'}">${submission.aiResult.fraudExplanation}</span>
                        </div>` : ''}
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(submission)}">${statusText}</span>
                    ${!submission.is_present ? `
                        <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors" onclick="runAiValidation('${submission.id}', '${currentClassSessionId}')">
                            <i data-lucide="brain-circuit" class="h-3 w-3 mr-1 inline"></i>
                            IA
                        </button>
                        <button class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors" onclick="validateAttendance('${submission.id}', '${currentClassSessionId}')">
                            <i data-lucide="check" class="h-3 w-3 mr-1 inline"></i>
                            Validar
                        </button>
                    ` : ''}
                </div>
            `;
            
            return div;
        }

        function getStatusBadgeClass(submission) {
            if (submission.is_present) return 'bg-green-100 text-green-800';
            if (submission.aiResult && submission.aiResult.isFraudulent) return 'bg-red-100 text-red-800';
            return 'bg-yellow-100 text-yellow-800';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const submissionTime = new Date(timestamp);
            const diffMs = now - submissionTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'agora';
            if (diffMins < 60) return diffMins + ' min';
            return Math.floor(diffMins / 60) + 'h';
        }

        function updateSubmissionCounts() {
            const all = currentSubmissions.length;
            const pending = currentSubmissions.filter(s => !s.is_present).length;
            const validated = currentSubmissions.filter(s => s.is_present).length;
            const suspicious = currentSubmissions.filter(s => s.aiResult && s.aiResult.isFraudulent).length;
            
            document.getElementById('allCount').textContent = all;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('validatedCount').textContent = validated;
            document.getElementById('suspiciousCount').textContent = suspicious;
            
            // Update dashboard stats
            document.getElementById('pendingSubmissions').textContent = pending;
            document.getElementById('submissionCount').textContent = all + ' submiss√µes';
            
            if (all > 0) {
                const rate = Math.round((validated / all) * 100);
                document.getElementById('todayAttendanceRate').textContent = rate + '%';
                document.getElementById('todayAttendanceText').textContent = validated + '/' + all + ' alunos presentes';
            }
        }

        function runAiValidation(recordId, sessionId) {
            if (!API_URLS.runAiValidation) {
                alert('URL da API n√£o dispon√≠vel.');
                return;
            }
            
            fetch(API_URLS.runAiValidation, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: new URLSearchParams({
                    'attendance_record_id': recordId,
                    'class_session_id': sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the submission in our local array
                    const submissionIndex = currentSubmissions.findIndex(s => s.id === recordId);
                    if (submissionIndex !== -1) {
                        currentSubmissions[submissionIndex].aiResult = data.aiResult;
                        renderSubmissions();
                        updateSubmissionCounts();
                    }
                    alert('Valida√ß√£o da IA conclu√≠da!');
                } else {
                    alert('Erro ao executar valida√ß√£o da IA: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro durante a valida√ß√£o da IA.');
            });
        }

        function validateAttendance(recordId, sessionId) {
            if (!API_URLS.validateAttendance) {
                alert('URL da API n√£o dispon√≠vel.');
                return;
            }
            
            fetch(API_URLS.validateAttendance, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: new URLSearchParams({
                    'attendance_record_id': recordId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the submission in our local array
                    const submissionIndex = currentSubmissions.findIndex(s => s.id === recordId);
                    if (submissionIndex !== -1) {
                        currentSubmissions[submissionIndex].is_present = true;
                        renderSubmissions();
                        updateSubmissionCounts();
                    }
                    alert('Presen√ßa validada com sucesso!');
                } else {
                    alert('Erro ao validar presen√ßa: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro durante a valida√ß√£o.');
            });
        }

        function validateAllPending() {
            const pendingSubmissions = currentSubmissions.filter(s => !s.is_present);
            if (pendingSubmissions.length === 0) {
                alert('N√£o h√° submiss√µes pendentes para validar.');
                return;
            }
            
            if (confirm(`Validar todas as ${pendingSubmissions.length} submiss√µes pendentes?`)) {
                pendingSubmissions.forEach(submission => {
                    validateAttendance(submission.id, currentClassSessionId);
                });
            }
        }

        // Filter functionality
        function initializeFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Remove active class from all buttons
                    filterButtons.forEach(b => {
                        b.classList.remove('bg-accent', 'text-white');
                        b.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    });
                    
                    // Add active class to clicked button
                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    btn.classList.add('bg-accent', 'text-white');
                    
                    currentFilter = btn.dataset.filter;
                    renderSubmissions();
                });
            });
        }

        // WebSocket functionality
        function initWebSocket(sessionId) {
            if (attendanceSocket && attendanceSocket.readyState === WebSocket.OPEN) {
                if (currentClassSessionId !== sessionId) {
                    attendanceSocket.close();
                } else {
                    return;
                }
            }
            
            currentClassSessionId = sessionId;
            const wsPath = 'ws://' + window.location.host.replace(':8000', ':8001') + '/ws/attendance/class_session_' + sessionId + '/';
            attendanceSocket = new WebSocket(wsPath);

            attendanceSocket.onopen = function(e) {
                console.log('WebSocket conectado');
                updateConnectionStatus(true);
            };

            attendanceSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Mensagem WebSocket:', data);
                
                if (data.context && data.context.type === 'student_submitted') {
                    // Add new submission to our array
                    currentSubmissions.unshift(data.context);
                    renderSubmissions();
                    updateSubmissionCounts();
                    
                    // Show notification
                    showNotification(`Nova submiss√£o de ${data.context.name}`);
                }
            };

            attendanceSocket.onclose = function(e) {
                console.log('WebSocket desconectado');
                updateConnectionStatus(false);
            };

            attendanceSocket.onerror = function(e) {
                console.error('Erro WebSocket:', e);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.className = connected ? 'w-3 h-3 bg-success rounded-full' : 'w-3 h-3 bg-danger rounded-full';
            }
        }

        function showNotification(message) {
            const notificationCount = document.getElementById('notificationCount');
            if (notificationCount) {
                const current = parseInt(notificationCount.textContent) || 0;
                notificationCount.textContent = current + 1;
                notificationCount.style.display = current >= 0 ? 'flex' : 'none';
            }
            
            // You could implement a toast notification here
            console.log('Notification:', message);
        }

        // Utility functions
        function exportSubmissions() {
            alert('Funcionalidade de exporta√ß√£o em desenvolvimento!');
        }

        function exportReport() {
            alert('Funcionalidade de relat√≥rio em desenvolvimento!');
        }

        function sendNotification() {
            alert('Funcionalidade de notifica√ß√£o em desenvolvimento!');
        }

        function openSettings() {
            alert('Funcionalidade de configura√ß√µes em desenvolvimento!');
        }

        // Session selection change handler
        function setupSessionSelector() {
            const sessionSelect = document.getElementById('classSessionSelect');
            if (sessionSelect) {
                sessionSelect.addEventListener('change', function(e) {
                    const selectedSessionId = e.target.value;
                    if (selectedSessionId) {
                        loadSubmissionsForSession(selectedSessionId);
                        
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        const courseName = selectedOption.dataset.courseName;
                        updateActiveSessionIndicator(courseName);
                    }
                });
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard do Professor inicializado');
            
            // Initialize UI components
            initializeFilters();
            setupSessionSelector();
            
            // Load initial data if available
            if (initialCodeDetails && initialCodeDetails.code) {
                updateCodeDisplay(initialCodeDetails.code, initialCodeDetails.expires_at);
                if (initialCodeDetails.class_session_id) {
                    initWebSocket(initialCodeDetails.class_session_id);
                }
            }

            if (initialStudentSubmissions && initialStudentSubmissions.length > 0) {
                currentSubmissions = initialStudentSubmissions;
                renderSubmissions();
                updateSubmissionCounts();
            }

            if (activeClassSessionIdInitial && activeClassSessionIdInitial !== 'null') {
                loadSubmissionsForSession(activeClassSessionIdInitial);
            }
            
            // Re-initialize Lucide icons after dynamic content
            lucide.createIcons();
        });
    </script>
</body>
{% endblock %}