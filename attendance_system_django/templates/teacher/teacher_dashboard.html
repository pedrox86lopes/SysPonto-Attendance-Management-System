{% extends 'base.html' %}
{% load static %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <h1 class="mb-4 text-center text-primary">Teacher Attendance Dashboard</h1>
            <p class="text-center text-muted">Manage attendance for your classes.</p>

            {# Code Generation Section #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Generate Attendance Code (10 minutes)</h5>
                </div>
                <div class="card-body">
                    {% if teacher_class_sessions_today %}
                    <form id="generateCodeForm" class="row g-3 align-items-end">
                        {% csrf_token %}
                        <div class="col-md-8">
                            <label for="classSessionSelect" class="form-label">Select Class Session for Code:</label>
                            <select class="form-select" id="classSessionSelect" name="class_session_id" required>
                                {% for session in teacher_class_sessions_today %}
                                <option value="{{ session.id }}"
                                    data-course-name="{{ session.course.name }}"
                                    data-start-time="{{ session.start_time|time:'H:i' }}"
                                    data-end-time="{{ session.end_time|time:'H:i' }}"
                                    {% if active_class_session_for_display and session.id == active_class_session_for_display.id %}selected{% endif %}>
                                    {{ session.course.name }} ({{ session.course.code }}) - {{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100" id="generateCodeBtn">Generate Code</button>
                        </div>
                    </form>
                    <hr>
                    <div id="codeDisplayArea" class="text-center mt-3">
                        {% if initial_code_details.code %}
                        <h4 class="text-secondary">Current Code for <span id="currentCodeCourseName">
                            {% if active_class_session_for_display %}{{ active_class_session_for_display.course.name }}{% endif %}
                        </span>:</h4>
                        <div class="d-flex justify-content-center align-items-center">
                            <h2 class="display-4 text-success fw-bold me-3" id="generatedCode">{{ initial_code_details.code }}</h2>
                            <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('#generatedCode')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <p class="text-muted" id="codeExpiresAt">Expires: <span id="expiresTime">{{ initial_code_details.expires_at|date:'H:i:s' }}</span></p>
                        {% else %}
                        <p class="text-muted" id="generatedCodePlaceholder">No active code for the selected class session.</p>
                        <p class="text-muted" id="codeExpiresAt"></p>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">You have no active or upcoming classes today to generate codes for.</p>
                    {% endif %}
                </div>
            </div>

            {# Student Submissions Section #}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Student Submissions for <span id="submissionsForClass">
                        {% if active_class_session_for_display %}{{ active_class_session_for_display.course.name }} ({{ active_class_session_for_display.start_time|time:'H:i' }} - {{ active_class_session_for_display.end_time|time:'H:i' }}){% else %}No Class Selected{% endif %}
                    </span></h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Time Submitted</th>
                                    <th>Status</th>
                                    <th>AI Result</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentSubmissionsTableBody">
                                {# Initial submissions loaded via Django template #}
                                {% for submission in initial_student_submissions_parsed %}
                                <tr id="record-{{ submission.id }}" class="{% if submission.is_present %}table-success{% else %}table-warning{% endif %}">
                                    <td>{{ submission.name }}</td>
                                    <td>{{ submission.timestamp|date:'H:i:s' }}</td>
                                    <td id="status-{{ submission.id }}">
                                        {% if submission.is_present %}
                                            <span class="badge bg-success">Present</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td id="ai-result-{{ submission.id }}">
                                        {% if submission.aiResult %}
                                            <span class="badge {% if submission.aiResult.isFraudulent %}bg-danger{% else %}bg-info{% endif %}">
                                                AI: {% if submission.aiResult.isFraudulent %}Fraud{% else %}OK{% endif %}
                                            </span>
                                            <small class="text-muted d-block">{{ submission.aiResult.fraudExplanation }}</small>
                                        {% else %}
                                            <span class="badge bg-secondary">Not Run</span>
                                        {% endif %}
                                    </td>
                                    <td id="actions-{{ submission.id }}">
                                        {% if not submission.is_present %}
                                        <button class="btn btn-sm btn-outline-success validate-btn" data-record-id="{{ submission.id }}" data-class-session-id="{{ active_class_session_for_display.id }}">Validate</button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-info ai-run-btn" data-record-id="{{ submission.id }}" data-class-session-id="{{ active_class_session_for_display.id }}">Run AI</button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="noSubmissionsRow"><td colspan="5" class="text-center text-muted">No student submissions yet for this class session.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://kit.fontawesome.com/your-font-awesome-kit.js" crossorigin="anonymous"></script> {# IMPORTANT: Replace with your actual Font Awesome kit URL #}
<script>
    // Parse initial data passed from Django context
    const initialCodeDetails = JSON.parse('{{ initial_code_details|escapejs }}');
    const initialSubmissions = JSON.parse('{{ initial_student_submissions|escapejs }}');
    const activeClassSessionId = '{{ active_class_session_id }}';
    const csrfToken = '{{ csrf_token }}';

    // Helper to copy text to clipboard
    function copyToClipboard(elementSelector) {
        const textToCopy = document.querySelector(elementSelector).textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert('Code copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    // Function to render a single submission row
    function renderSubmissionRow(submission) {
        const isPresentBadge = submission.is_present ? '<span class="badge bg-success">Present</span>' : '<span class="badge bg-warning text-dark">Pending</span>';
        let aiResultBadge = '<span class="badge bg-secondary">Not Run</span>';
        let aiExplanation = '';
        if (submission.aiResult) {
            const aiBgClass = submission.aiResult.isFraudulent ? 'bg-danger' : 'bg-info';
            aiResultBadge = `<span class="badge ${aiBgClass}">AI: ${submission.aiResult.isFraudulent ? 'Fraud' : 'OK'}</span>`;
            aiExplanation = `<small class="text-muted d-block">${submission.aiResult.fraudExplanation}</small>`;
        }

        const validateBtnHtml = submission.is_present ? '' : `<button class="btn btn-sm btn-outline-success validate-btn" data-record-id="${submission.id}" data-class-session-id="${submission.class_session_id}">Validate</button>`;
        const rowClass = submission.is_present ? 'table-success' : 'table-warning';

        return `
            <tr id="record-${submission.id}" class="${rowClass}">
                <td>${submission.name}</td>
                <td>${new Date(submission.timestamp).toLocaleTimeString()}</td>
                <td id="status-${submission.id}">${isPresentBadge}</td>
                <td id="ai-result-${submission.id}">${aiResultBadge}${aiExplanation}</td>
                <td id="actions-${submission.id}">
                    ${validateBtnHtml}
                    <button class="btn btn-sm btn-outline-info ai-run-btn" data-record-id="${submission.id}" data-class-session-id="${submission.class_session_id}">Run AI</button>
                </td>
            </tr>
        `;
    }

    // Function to attach event listeners to buttons (Validate, Run AI)
    function attachButtonListeners() {
        document.querySelectorAll('.validate-btn').forEach(button => {
            button.onclick = async (event) => {
                const recordId = event.target.dataset.recordId;
                const classSessionId = event.target.dataset.classSessionId; // Pass class_session_id for authorization check
                try {
                    const response = await fetch('/attendance/validate-attendance/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `attendance_record_id=${recordId}`
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        // Update UI for the specific record
                        const row = document.getElementById(`record-${recordId}`);
                        if (row) {
                            row.classList.remove('table-warning');
                            row.classList.add('table-success');
                        }
                        const statusCell = document.getElementById(`status-${recordId}`);
                        if (statusCell) {
                            statusCell.innerHTML = '<span class="badge bg-success">Present</span>';
                        }
                        event.target.remove(); // Remove the validate button
                    } else {
                        alert(`Error validating attendance: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred during validation.');
                }
            };
        });

        document.querySelectorAll('.ai-run-btn').forEach(button => {
            button.onclick = async (event) => {
                const recordId = event.target.dataset.recordId;
                const classSessionId = event.target.dataset.classSessionId; // Pass class_session_id for authorization check
                try {
                    const response = await fetch('/attendance/run-ai-validation/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `attendance_record_id=${recordId}&class_session_id=${classSessionId}`
                    });
                    const data = await response.json();
                    if (data.status === 'success' && data.aiResult) {
                        const aiResultCell = document.getElementById(`ai-result-${recordId}`);
                        if (aiResultCell) {
                            const aiBgClass = data.aiResult.isFraudulent ? 'bg-danger' : 'bg-info';
                            aiResultCell.innerHTML = `
                                <span class="badge ${aiBgClass}">AI: ${data.aiResult.isFraudulent ? 'Fraud' : 'OK'}</span>
                                <small class="text-muted d-block">${data.aiResult.fraudExplanation}</small>
                            `;
                        }
                    } else {
                        alert(`Error running AI validation: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred during AI validation.');
                }
            };
        });
    }

    // --- WebSocket for Real-time Notifications ---
    let attendanceSocket = null;

    function connectWebSocket(sessionId) {
        if (attendanceSocket && attendanceSocket.readyState === WebSocket.OPEN) {
            attendanceSocket.close(); // Close existing connection if any
        }
        if (!sessionId) {
            console.warn("No active class session ID provided for WebSocket connection. Cannot connect.");
            return;
        }

        // Construct WebSocket URL
        // Use 'ws://' for http and 'wss://' for https
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const hostname = window.location.host;
        // The WebSocket URL is now dynamic based on the class_session_id
        const wsUrl = `${protocol}${hostname}/ws/attendance/class_session_${sessionId}/`;

        attendanceSocket = new WebSocket(wsUrl);

        attendanceSocket.onopen = function(e) {
            console.log("WebSocket connection established for session:", sessionId);
        };

        attendanceSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'send_notification' && data.context && data.context.class_session_id == activeClassSessionId) {
                // Handle student submission notification
                if (data.message_type === 'student_submitted') {
                    const newSubmission = data.context;
                    console.log("New student submission received:", newSubmission);

                    // Add the new submission to the table
                    const tbody = document.getElementById('studentSubmissionsTableBody');
                    const noSubmissionsRow = document.getElementById('noSubmissionsRow');
                    if (noSubmissionsRow) {
                        noSubmissionsRow.remove(); // Remove "No submissions" message
                    }
                    // Prepend new submission to the top of the table
                    tbody.insertAdjacentHTML('afterbegin', renderSubmissionRow(newSubmission));
                    attachButtonListeners(); // Re-attach listeners for new row
                } 
                // Handle code generation notification (if you want the dashboard itself to react to its own code generation)
                else if (data.message_type === 'code_generated_for_teacher') {
                    // This notification is typically handled by the generate code view,
                    // but if the dashboard is open, it can update itself.
                    const codeContext = data.context;
                    if (codeContext.class_session_id == activeClassSessionId) {
                        document.getElementById('generatedCodePlaceholder').style.display = 'none';
                        document.getElementById('generatedCode').textContent = codeContext.code;
                        document.getElementById('expiresTime').textContent = new Date(codeContext.expires_at).toLocaleTimeString();
                    }
                }
            }
        };

        attendanceSocket.onclose = function(e) {
            console.log('WebSocket closed for session:', sessionId, ' Code:', e.code, ' Reason:', e.reason);
            // Optionally try to reconnect after a delay
            // setTimeout(() => connectWebSocket(sessionId), 3000); 
        };

        attendanceSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }

    // --- Page Load and Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial setup for buttons
        attachButtonListeners();

        // Connect WebSocket for the initially displayed active session
        // This makes the dashboard receive real-time updates for its primary displayed class.
        if (activeClassSessionId) {
            connectWebSocket(activeClassSessionId);
        }

        // Handle class session selection change in the dropdown
        const classSessionSelect = document.getElementById('classSessionSelect');
        if (classSessionSelect) {
            classSessionSelect.addEventListener('change', async (event) => {
                const selectedSessionId = event.target.value;
                const selectedOption = event.target.options[event.target.selectedIndex];
                const courseName = selectedOption.dataset.courseName;
                const startTime = selectedOption.dataset.startTime;
                const endTime = selectedOption.dataset.endTime;

                // Update the "Submissions For Class" header
                document.getElementById('submissionsForClass').textContent = `${courseName} (${startTime} - ${endTime})`;
                
                // Update the activeClassSessionId global variable
                // This is crucial for the WebSocket to listen to the correct group
                // and for buttons to have the correct data-class-session-id.
                window.activeClassSessionId = selectedSessionId;

                // Reconnect WebSocket to the newly selected class session's group
                connectWebSocket(selectedSessionId);

                // For a proper solution, you'd make an AJAX call here to fetch current submissions
                // and current code status for the newly selected `selectedSessionId` and then
                // update `studentSubmissionsTableBody` and `codeDisplayArea`.
                
                // --- Placeholder for AJAX fetching submissions for new class ---
                document.getElementById('studentSubmissionsTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted">Loading submissions...</td></tr>';
                // You would typically make an AJAX request here like:
                // fetch(`/api/get-submissions-for-session/${selectedSessionId}/`)
                //    .then(response => response.json())
                //    .then(data => updateSubmissionsTable(data.submissions));
                // For now, it will show "Loading..." and then "No submissions" until real AJAX is implemented.
                setTimeout(() => { // Simulate network delay for fetching data
                    document.getElementById('studentSubmissionsTableBody').innerHTML = '<tr id="noSubmissionsRow"><td colspan="5" class="text-center text-muted">No student submissions yet for this class session. (Implement AJAX fetch)</td></tr>';
                }, 500);

                // --- Placeholder for AJAX fetching current code for new class ---
                // You would typically make an AJAX request here like:
                // fetch(`/api/get-code-for-session/${selectedSessionId}/`)
                //    .then(response => response.json())
                //    .then(data => {
                //        if (data.code_status === 'active') {
                //            document.getElementById('generatedCodePlaceholder').style.display = 'none';
                //            document.getElementById('generatedCode').textContent = data.code;
                //            document.getElementById('expiresTime').textContent = new Date(data.expires_at).toLocaleTimeString();
                //            document.getElementById('currentCodeCourseName').textContent = courseName;
                //        } else {
                //            document.getElementById('generatedCodePlaceholder').style.display = 'block';
                //            document.getElementById('generatedCode').textContent = '';
                //            document.getElementById('expiresTime').textContent = '';
                //            document.getElementById('currentCodeCourseName').textContent = courseName;
                //        }
                //    });
                
                // For now, clear code display and show placeholder for the selected class.
                document.getElementById('generatedCodePlaceholder').style.display = 'block';
                document.getElementById('generatedCode').textContent = '';
                document.getElementById('codeExpiresAt').textContent = '';
                document.getElementById('currentCodeCourseName').textContent = courseName;
            });
        }

        // Handle Generate Code form submission
        const generateCodeForm = document.getElementById('generateCodeForm');
        if (generateCodeForm) {
            generateCodeForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const selectedSessionId = document.getElementById('classSessionSelect').value;
                if (!selectedSessionId) {
                    alert('Please select a class session to generate a code.');
                    return;
                }

                document.getElementById('generateCodeBtn').disabled = true;
                document.getElementById('generateCodeBtn').textContent = 'Generating...';

                try {
                    const response = await fetch('/attendance/generate-attendance-code/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `class_session_id=${selectedSessionId}`
                    });
                    const data = await response.json();

                    if (data.status === 'success') {
                        document.getElementById('generatedCodePlaceholder').style.display = 'none';
                        document.getElementById('generatedCode').textContent = data.code;
                        document.getElementById('expiresTime').textContent = new Date(data.expires_at).toLocaleTimeString();
                        document.getElementById('currentCodeCourseName').textContent = document.getElementById('classSessionSelect').options[document.getElementById('classSessionSelect').selectedIndex].dataset.courseName;
                        alert('Attendance code generated successfully!');
                    } else {
                        alert(`Error generating code: ${data.message}`);
                        document.getElementById('generatedCode').textContent = 'Error';
                        document.getElementById('expiresTime').textContent = '';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred during code generation.');
                    document.getElementById('generatedCode').textContent = 'Error';
                    document.getElementById('expiresTime').textContent = '';
                } finally {
                    document.getElementById('generateCodeBtn').disabled = false;
                    document.getElementById('generateCodeBtn').textContent = 'Generate Code';
                }
            });
        }
    });

    // Initial parsing of submissions for dynamic rendering on page load.
    // This is useful if you later decide to re-render the table purely with JS.
    // For now, the Django template loop already renders the initial state.
    let initialSubmissionsParsed = [];
    try {
        initialSubmissionsParsed = JSON.parse('{{ initial_student_submissions|escapejs }}');
    } catch (e) {
        console.error("Error parsing initial_student_submissions:", e);
    }
    // If you uncomment the `updateSubmissionsTable` call in DOMContentLoaded,
    // ensure `initialSubmissionsParsed` is correctly populated first.

    // A note on `activeClassSessionId`: In this setup, it's used to identify
    // which class's submissions are currently being displayed and which
    // WebSocket group to connect to for real-time updates. When the teacher
    // changes the selected class in the dropdown, this `activeClassSessionId`
    // needs to be updated to switch the real-time feed.
</script>
{% endblock %}