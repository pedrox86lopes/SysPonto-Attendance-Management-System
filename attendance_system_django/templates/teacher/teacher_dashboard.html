{% extends 'teacher/teacher_base.html' %}

{% block title %}Teacher Dashboard{% endblock %}

{% block teacher_content %}
<div class="space-y-8">
    <div class="text-center">
        <h1 class="text-4xl font-headline font-bold text-primary">Attendance Dashboard</h1>
        <p class="text-lg text-muted-foreground mt-2">
            Current Class Code: <span id="current-code-dashboard" class="font-bold text-accent font-mono tracking-wider">
                </span>
            <span id="code-status-badge-dashboard" class="ml-2">
                </span>
        </p>
        <p id="primary-location-display" class="text-sm text-muted-foreground mt-1">
            </p>
    </div>

    <div class="grid gap-4 md:grid-cols-3">
        <div class="bg-card text-card-foreground rounded-lg border shadow-lg">
            <div class="flex flex-row items-center justify-between space-y-0 pb-2 p-6">
                <h3 class="text-sm font-medium">Total Submissions</h3>
                <i data-lucide="users" class="h-5 w-5 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
                <div id="total-submissions" class="text-2xl font-bold">0</div>
                <p class="text-xs text-muted-foreground">
                    students have submitted the code.
                </p>
            </div>
        </div>
        <div class="bg-card text-card-foreground rounded-lg border shadow-lg">
            <div class="flex flex-row items-center justify-between space-y-0 pb-2 p-6">
                <h3 class="text-sm font-medium">AI Analyses Performed</h3>
                <i data-lucide="scan-search" class="h-5 w-5 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
                <div id="ai-analyses-performed" class="text-2xl font-bold">0</div>
                <p class="text-xs text-muted-foreground">
                    out of 0 submissions analyzed.
                </p>
            </div>
        </div>
        <div class="bg-card text-card-foreground rounded-lg border shadow-lg">
            <div class="flex flex-row items-center justify-between space-y-0 pb-2 p-6">
                <h3 class="text-sm font-medium">Potential Fraud Alerts</h3>
                <i data-lucide="alert-triangle" class="h-5 w-5 text-destructive"></i>
            </div>
            <div class="p-6 pt-0">
                <div id="potential-fraud-alerts" class="text-2xl font-bold">0</div>
                <p class="text-xs text-muted-foreground">
                    submissions flagged by AI.
                </p>
            </div>
        </div>
    </div>

    <div id="chart-container-wrapper">
        </div>


    <div id="no-submissions-card" class="{% if initial_student_submissions|length > 2 or initial_code_details.code_status == 'inactive' %}hidden{% endif %} text-center py-10 bg-card text-card-foreground rounded-lg border shadow-lg">
        <div class="p-6">
            <i data-lucide="help-circle" class="mx-auto h-12 w-12 text-muted-foreground mb-4"></i>
            <h3 class="text-2xl font-headline font-semibold">No Submissions Yet</h3>
            <p class="text-muted-foreground mt-2">Waiting for students to submit the class code.</p>
            <p class="text-sm mt-1">Share the code <span class="font-bold text-accent font-mono" id="share-code-display"></span> with your students.</p>
        </div>
    </div>


    <div id="student-submissions-card" class="{% if initial_student_submissions|length <= 2 %}hidden{% endif %} bg-card text-card-foreground rounded-lg border shadow-xl">
        <div class="p-6">
            <h2 class="text-2xl font-headline font-semibold">Student Submissions (<span id="submission-count">0</span>)</h2>
            <p class="text-muted-foreground mt-2">Review student attendance and use AI validation for potential fraud detection.</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Student Name</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Submitted At</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">IP Address</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0">Geolocation (Lat, Lon)</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 text-center">AI Validation</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="student-submissions-table-body" class="[&_tr:last-child]:border-0">
                    </tbody>
            </table>
        </div>
        <div class="p-6">
            <p class="text-xs text-muted-foreground">AI validation provides an indication and should be used as a guide. Always verify with other means if concerned.</p>
        </div>
    </div>
</div>
{% endblock teacher_content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initial data passed from Django view
        let classCodeDetails = JSON.parse('{{ initial_code_details|safe }}');
        let studentSubmissions = JSON.parse('{{ initial_student_submissions|safe }}');
        const knownValidLocations = JSON.parse('{{ known_valid_locations|safe }}');
        const activeClassSessionId = '{{ active_class_session_id|default:"" }}';

        let remainingTimeInterval;
        let chartInstance; // To hold the Chart.js instance

        const currentCodeDashboard = document.getElementById('current-code-dashboard');
        const codeStatusBadgeDashboard = document.getElementById('code-status-badge-dashboard');
        const primaryLocationDisplay = document.getElementById('primary-location-display');
        const totalSubmissionsEl = document.getElementById('total-submissions');
        const aiAnalysesPerformedEl = document.getElementById('ai-analyses-performed');
        const potentialFraudAlertsEl = document.getElementById('potential-fraud-alerts');
        const submissionCountEl = document.getElementById('submission-count');
        const noSubmissionsCard = document.getElementById('no-submissions-card');
        const studentSubmissionsCard = document.getElementById('student-submissions-card');
        const studentSubmissionsTableBody = document.getElementById('student-submissions-table-body');
        const shareCodeDisplay = document.getElementById('share-code-display');
        const chartContainerWrapper = document.getElementById('chart-container-wrapper');

        function updateDashboardUI() {
            // Update code display and status
            if (classCodeDetails && classCodeDetails.code_status !== 'inactive') {
                currentCodeDashboard.textContent = classCodeDetails.code;
                shareCodeDisplay.textContent = classCodeDetails.code; // For "No Submissions Yet" card
                startRemainingTimeTimer();
                noSubmissionsCard.classList.remove('hidden'); // Show if no submissions, hide otherwise
            } else {
                currentCodeDashboard.textContent = 'N/A';
                shareCodeDisplay.textContent = 'N/A';
                codeStatusBadgeDashboard.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-muted text-muted-foreground">No Active Code</span>`;
                clearInterval(remainingTimeInterval);
                noSubmissionsCard.classList.remove('hidden'); // Always show "No Active Code" message
                studentSubmissionsCard.classList.add('hidden'); // Hide submission table
            }

            // Update primary valid location
            if (knownValidLocations && knownValidLocations.length > 0) {
                primaryLocationDisplay.textContent = `Primary Valid Location: Lat ${knownValidLocations[0].latitude.toFixed(4)}, Lon ${knownValidLocations[0].longitude.toFixed(4)}`;
            } else {
                primaryLocationDisplay.textContent = '';
            }

            // Update stats cards
            const total = studentSubmissions.length;
            const aiPerformed = studentSubmissions.filter(s => s.aiResult).length;
            const fraudAlerts = studentSubmissions.filter(s => s.aiResult?.isFraudulent).length;
            const looksOk = aiPerformed - fraudAlerts;

            totalSubmissionsEl.textContent = total;
            aiAnalysesPerformedEl.textContent = aiPerformed;
            aiAnalysesPerformedEl.nextElementSibling.textContent = `out of ${total} submissions analyzed.`;
            potentialFraudAlertsEl.textContent = fraudAlerts;
            submissionCountEl.textContent = total;

            // Toggle submission table visibility
            if (total > 0 && classCodeDetails.code_status !== 'inactive') {
                noSubmissionsCard.classList.add('hidden');
                studentSubmissionsCard.classList.remove('hidden');
            } else {
                studentSubmissionsCard.classList.add('hidden');
                if (classCodeDetails.code_status !== 'inactive') { // Only show no submissions card if code is active/expired
                    noSubmissionsCard.classList.remove('hidden');
                }
            }


            // Render student submissions table
            renderSubmissionsTable();

            // Render chart
            renderChart(looksOk, fraudAlerts);

            lucide.createIcons(); // Re-render Lucide icons
        }

        function startRemainingTimeTimer() {
            clearInterval(remainingTimeInterval);
            if (classCodeDetails && classCodeDetails.expires_at) {
                remainingTimeInterval = setInterval(() => {
                    const expiryTime = new Date(classCodeDetails.expires_at);
                    const now = new Date();
                    const diffSeconds = Math.max(0, Math.floor((expiryTime.getTime() - now.getTime()) / 1000));

                    const minutes = Math.floor(diffSeconds / 60);
                    const seconds = diffSeconds % 60;

                    const timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    if (diffSeconds > 0) {
                        codeStatusBadgeDashboard.innerHTML = `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500 text-white">
                                <i data-lucide="clock" class="mr-1 h-3 w-3"></i> Active: ${timeDisplay}
                            </span>
                        `;
                    } else {
                        classCodeDetails.code_status = 'expired';
                        codeStatusBadgeDashboard.innerHTML = `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-destructive text-destructive-foreground">
                                <i data-lucide="clock" class="mr-1 h-3 w-3"></i> Expired
                            </span>
                        `;
                        clearInterval(remainingTimeInterval);
                    }
                    lucide.createIcons();
                }, 1000);
            }
        }

        function renderSubmissionsTable() {
            studentSubmissionsTableBody.innerHTML = ''; // Clear existing rows
            studentSubmissions.forEach(submission => {
                const row = document.createElement('tr');
                row.id = `submission-row-${submission.id}`;
                row.className = 'border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted';

                const submittedAt = new Date(submission.timestamp);
                const aiBadge = submission.aiResult
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${submission.aiResult.isFraudulent ? 'bg-destructive text-destructive-foreground' : 'bg-primary text-primary-foreground'} cursor-pointer" title="${submission.aiResult.fraudExplanation}">
                        <i data-lucide="${submission.aiResult.isFraudulent ? 'alert-circle' : 'check-circle'}" class="mr-1 h-4 w-4"></i>
                        ${submission.aiResult.isFraudulent ? "Potential Fraud" : "Looks OK"}
                      </span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-muted text-muted-foreground cursor-default">Not Analyzed</span>`;

                const geolocationDisplay = submission.simulatedGeolocation
                    ? `${submission.simulatedGeolocation.latitude.toFixed(2)}, ${submission.simulatedGeolocation.longitude.toFixed(2)}`
                    : "N/A";

                row.innerHTML = `
                    <td class="p-4 align-middle font-medium">${submission.name}</td>
                    <td class="p-4 align-middle">
                        <div class="flex items-center gap-1 text-sm text-muted-foreground">
                            <i data-lucide="clock" class="h-4 w-4"></i>
                            ${submittedAt.toLocaleString()}
                        </div>
                    </td>
                    <td class="p-4 align-middle">
                        <div class="flex items-center gap-1 text-sm text-muted-foreground">
                            <i data-lucide="wifi" class="h-4 w-4"></i>
                            ${submission.simulatedIp || "N/A"}
                        </div>
                    </td>
                    <td class="p-4 align-middle">
                        <div class="flex items-center gap-1 text-sm text-muted-foreground">
                            <i data-lucide="map-pin" class="h-4 w-4"></i>
                            ${geolocationDisplay}
                        </div>
                    </td>
                    <td class="p-4 align-middle text-center">
                        <div id="ai-status-${submission.id}">
                            ${submission.aiLoading ? '<div class="w-24 mx-auto h-2 bg-secondary rounded-full animate-pulse"></div>' : aiBadge}
                        </div>
                    </td>
                    <td class="p-4 align-middle text-right">
                        <button type="button" data-record-id="${submission.id}" class="run-ai-validation-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 h-9 px-4 py-2 bg-accent hover:bg-accent/90 text-accent-foreground">
                            <i data-lucide="sparkles" class="mr-2 h-4 w-4"></i>
                            ${submission.aiResult ? "Re-analyze" : "Analyze"}
                        </button>
                        ${!submission.is_present ? `
                            <button type="button" data-record-id="${submission.id}" class="validate-attendance-btn inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 h-9 px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground ml-2">
                                <i data-lucide="check" class="mr-2 h-4 w-4"></i>
                                Validate
                            </button>
                        ` : `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500 text-white ml-2">
                                <i data-lucide="check" class="mr-1 h-3 w-3"></i> Present
                            </span>
                        `}
                    </td>
                `;
                studentSubmissionsTableBody.appendChild(row);
            });
            attachEventHandlers(); // Attach handlers to new buttons
            lucide.createIcons(); // Re-render Lucide icons
        }

        function attachEventHandlers() {
            document.querySelectorAll('.run-ai-validation-btn').forEach(button => {
                button.onclick = async () => {
                    const recordId = button.dataset.recordId;
                    const submission = studentSubmissions.find(s => s.id == recordId);
                    if (!submission || classCodeDetails.code_status !== 'active') return;

                    // Update UI to show loading state
                    const aiStatusDiv = document.getElementById(`ai-status-${recordId}`);
                    if (aiStatusDiv) {
                        aiStatusDiv.innerHTML = '<div class="w-24 mx-auto h-2 bg-secondary rounded-full animate-pulse"></div>';
                    }
                    button.disabled = true;

                    try {
                        const response = await fetch('{% url "run_ai_validation" %}', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `attendance_record_id=${recordId}&class_session_id=${activeClassSessionId}`
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            const updatedSubmission = { ...submission, aiResult: data.aiResult };
                            studentSubmissions = studentSubmissions.map(s => s.id === updatedSubmission.id ? updatedSubmission : s);
                            showToast({title: "AI Analysis Complete", description: data.aiResult.fraudExplanation, variant: data.aiResult.isFraudulent ? "destructive" : "success"});
                            updateDashboardUI(); // Re-render everything to update stats and table
                        } else {
                            showToast({title: "AI Analysis Error", description: data.message, variant: "destructive"});
                        }
                    } catch (error) {
                        console.error('Error running AI validation:', error);
                        showToast({title: "Error", description: "Failed to run AI validation.", variant: "destructive"});
                    } finally {
                        button.disabled = false; // Re-enable button after attempt
                    }
                };
            });

            document.querySelectorAll('.validate-attendance-btn').forEach(button => {
                button.onclick = async () => {
                    const recordId = button.dataset.recordId;
                    const submission = studentSubmissions.find(s => s.id == recordId);
                    if (!submission) return;

                    button.disabled = true;

                    try {
                        const response = await fetch('{% url "validate_attendance" %}', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `attendance_record_id=${recordId}`
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            const updatedSubmission = { ...submission, is_present: true };
                            studentSubmissions = studentSubmissions.map(s => s.id === updatedSubmission.id ? updatedSubmission : s);
                            showToast({title: "Attendance Validated!", description: data.message, variant: "success"});
                            updateDashboardUI(); // Re-render everything
                        } else {
                            showToast({title: "Validation Error", description: data.message, variant: "destructive"});
                        }
                    } catch (error) {
                        console.error('Error validating attendance:', error);
                        showToast({title: "Error", description: "Failed to validate attendance.", variant: "destructive"});
                    } finally {
                        button.disabled = false;
                    }
                };
            });
        }


        // Chart.js rendering function
        function renderChart(looksOk, fraudulent) {
            if (chartInstance) {
                chartInstance.destroy(); // Destroy old chart instance
            }
            if (!chartContainerWrapper) return; // Ensure container exists

            // Clear previous content
            chartContainerWrapper.innerHTML = `
                <div class="bg-card text-card-foreground rounded-lg border shadow-xl">
                    <div class="p-6">
                        <h3 class="text-xl font-headline font-semibold">AI Validation Overview</h3>
                        <p class="text-muted-foreground mt-2">Breakdown of AI validated submissions.</p>
                    </div>
                    <div class="p-4 h-[300px]">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>
            `;

            const ctx = document.getElementById('attendanceChart');
            if (!ctx) return;

            const chartData = {
                labels: ['AI Validation'],
                datasets: [
                    {
                        label: 'Looks OK',
                        data: [looksOk],
                        backgroundColor: 'hsl(var(--primary))', // Use CSS variable
                        borderRadius: 4,
                    },
                    {
                        label: 'Potential Fraud',
                        data: [fraudulent],
                        backgroundColor: 'hsl(var(--destructive))', // Use CSS variable
                        borderRadius: 4,
                    },
                ],
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { display: false },
                        border: { display: false }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: { color: 'hsl(var(--border))' },
                        ticks: { color: 'hsl(var(--muted-foreground))' },
                        border: { display: false }
                    },
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'hsl(var(--foreground))',
                            usePointStyle: true,
                        }
                    },
                    tooltip: {
                        backgroundColor: 'hsl(var(--card))',
                        titleColor: 'hsl(var(--card-foreground))',
                        bodyColor: 'hsl(var(--muted-foreground))',
                        borderColor: 'hsl(var(--border))',
                        borderWidth: 1,
                        cornerRadius: 4,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                }
            };

            if (looksOk + fraudulent > 0) { // Only render if there's data to show
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: chartOptions,
                });
            } else {
                 chartContainerWrapper.innerHTML = `
                    <div class="bg-card text-card-foreground rounded-lg border shadow-xl p-6 text-center">
                        <h3 class="text-xl font-headline font-semibold">AI Validation Overview</h3>
                        <p class="text-muted-foreground mt-2">No AI analyses performed yet.</p>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // Initial UI rendering
        updateDashboardUI();

        // Global function for WebSocket updates (from base.html)
        window.updateTeacherDashboardOnSubmission = function(context) {
            // Add new submission to local state
            const newSubmission = {
                id: context.attendance_record_id,
                name: context.student_name,
                timestamp: new Date().toISOString(), // Use current time or context.timestamp if provided
                simulatedIp: 'N/A', // Not sent via WS, will be N/A or require another fetch
                simulatedGeolocation: null, // Not sent via WS
                aiResult: null,
                is_present: false,
            };
            studentSubmissions.push(newSubmission);
            updateDashboardUI(); // Re-render dashboard
            showToast({title: "New Submission!", description: `Student ${context.student_name} submitted attendance for your class.`, variant: "success"});
        };
    });
</script>
{% endblock extra_js %}