{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard do Formador | SysPonto{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#1f2937',
                    accent: '#3b82f6',
                    success: '#10b981',
                    warning: '#f59e0b',
                    danger: '#ef4444'
                }
            }
        }
    }
</script>
{% endblock extra_css %}

{% block content %}

<body class="bg-gray-50">
    <!-- Navigation Header -->
    <nav class="bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <i data-lucide="shield-check" class="h-8 w-8"></i>
                    <h1 class="text-xl font-bold">SysPonto - Formador</h1>
                </div>
                <div class="flex items-center space-x-6">
                    <!-- Notifications -->
                    <div class="relative">
                        <button class="text-white hover:text-gray-300 relative" id="notificationBtn"
                            onclick="scrollToSubmissions()" title="Ver submissões pendentes">
                            <i data-lucide="bell" class="h-6 w-6"></i>
                            <span
                                class="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full h-5 w-5 flex items-center justify-center text-white"
                                id="notificationCount" style="display: none;">0</span>
                        </button>
                    </div>
                    <!-- Connection Status -->
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-success rounded-full" id="connectionStatus"></div>
                        <span class="text-sm">Conectado</span>
                    </div>
                    <!-- User Info -->
                    <div class="flex items-center space-x-2">
                        <i data-lucide="user" class="h-5 w-5"></i>
                        <span class="text-sm">{{ request.user.get_full_name|default:request.user.username }}</span>
                    </div>
                    <a href="#" onclick="logoutConfirm()" class="text-white hover:text-gray-300">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Welcome Section -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Bem-vindo, Professor {{
                        request.user.get_full_name|default:request.user.username }}!</h2>
                    <p class="text-gray-600">Faça a gestão das suas turmas e monitoriza a presença em tempo real.</p>
                </div>
                <!-- Active Session Indicator -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4" id="activeSessionIndicator"
                    style="display: none;">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                        <div>
                            <p class="font-semibold text-green-800">Aula Ativa</p>
                            <p class="text-sm text-green-600" id="activeSessionName">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-accent">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Submissões Pendentes</p>
                        <p class="text-2xl font-bold text-accent" id="pendingSubmissions">0</p>
                        <p class="text-sm text-gray-500">Aguardam validação</p>
                    </div>
                    <i data-lucide="users" class="h-8 w-8 text-accent"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-success">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Taxa de Presença Hoje</p>
                        <p class="text-2xl font-bold text-success" id="todayAttendanceRate">--%</p>
                        <p class="text-sm text-success" id="todayAttendanceText">-- alunos presentes</p>
                    </div>
                    <i data-lucide="trending-up" class="h-8 w-8 text-success"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-warning">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Aulas Hoje</p>
                        <p class="text-2xl font-bold text-warning" id="todaySessionCount">{{
                            teacher_class_sessions_today|length }}</p>
                        <p class="text-sm text-gray-500">{{ teacher_class_sessions_today|length }} sessões programadas
                        </p>
                    </div>
                    <i data-lucide="calendar" class="h-8 w-8 text-warning"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Códigos Ativos</p>
                        <p class="text-2xl font-bold text-purple-500" id="activeCodesCount">0</p>
                        <p class="text-sm text-gray-500">Em circulação</p>
                    </div>
                    <i data-lucide="key" class="h-8 w-8 text-purple-500"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Main Controls -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Code Generation Section -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i data-lucide="key" class="h-5 w-5 mr-2 text-accent"></i>
                                Gerar Código de Presença
                            </h3>
                            <div class="flex items-center space-x-2" id="codeStatusIndicator">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                <span class="text-sm text-gray-500">Sem código ativo</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <!-- Class Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Turma:</label>
                            <select
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent"
                                id="classSessionSelect">
                                {% for session in teacher_class_sessions_today %}
                                <option value="{{ session.id }}" data-course-name="{{ session.course.name }}"
                                    data-start-time="{{ session.start_time|time:'H:i' }}"
                                    data-end-time="{{ session.end_time|time:'H:i' }}" {% if
                                    active_class_session_for_display and session.id == active_class_session_for_display.id %}selected{% endif %}>
                                    {{ session.course.name }} - {{ session.start_time|time:"H:i" }} - {{
                                    session.end_time|time:"H:i" }}
                                </option>
                                {% empty %}
                                <option value="">Não há aulas hoje.</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Active Code Display -->
                        <div class="bg-gradient-to-r from-accent to-blue-600 rounded-lg p-6 text-white mb-4"
                            id="activeCodeDisplay" style="display: none;">
                            <div class="text-center">
                                <p class="text-sm opacity-90 mb-2">Código Atual:</p>
                                <div class="flex items-center justify-center space-x-4">
                                    <p class="text-4xl font-mono font-bold tracking-widest" id="currentCode">------</p>
                                    <button
                                        class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg p-2 transition-colors"
                                        onclick="copyCodeToClipboard()">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                                <div class="mt-3 flex items-center justify-center space-x-4">
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="clock" class="h-4 w-4 mr-1"></i>
                                        <span id="timeRemaining">Expira em: --:--</span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="users" class="h-4 w-4 mr-1"></i>
                                        <span id="submissionCount">0 submissões</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <button
                                class="flex-1 bg-accent text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                                onclick="generateNewCode()" id="generateCodeBtn">
                                Gerar Novo Código
                            </button>
                            <button
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                                onclick="deactivateCode()" id="deactivateBtn" style="display: none;">
                                Desactivar
                            </button>
                            <button
                                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                onclick="validateAllPending()" id="validateAllBtn">
                                Validar Todas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Real-time Submissions -->
                <div class="bg-white rounded-lg shadow" id="submissionsSection">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i data-lucide="activity" class="h-5 w-5 mr-2 text-green-500"></i>
                                Submissões em Tempo Real
                            </h3>
                            <div class="flex items-center space-x-3">

                                <div class="text-sm text-gray-500" id="lastUpdated">Nunca atualizado</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <!-- Filters -->
                        <div class="flex space-x-2 mb-4">
                            <button class="px-3 py-1 bg-accent text-white rounded-full text-sm filter-btn active"
                                data-filter="all">Todos (<span id="allCount">0</span>)</button>
                            <button
                                class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 filter-btn"
                                data-filter="pending">Pendentes (<span id="pendingCount">0</span>)</button>
                            <button
                                class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 filter-btn"
                                data-filter="validated">Validados (<span id="validatedCount">0</span>)</button>
                            <button
                                class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 filter-btn"
                                data-filter="suspicious">Suspeitos (<span id="suspiciousCount">0</span>)</button>
                        </div>

                        <!-- Submissions List -->
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="submissionsList">
                            <div class="text-center text-gray-500 py-8">
                                Selecione uma sessão para ver os envios.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Side Panels -->
            <div class="space-y-6">
                <!-- Today's Schedule -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="calendar-days" class="h-5 w-5 mr-2 text-accent"></i>
                            Horário de Hoje
                        </h3>
                    </div>
                    <div class="p-6 space-y-3" id="todayScheduleList">
                        {% for session in teacher_class_sessions_today %}
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold text-blue-800">{{ session.course.name }}</p>
                                    <p class="text-sm text-blue-600">{{ session.start_time|time:"H:i" }} - {{
                                        session.end_time|time:"H:i" }}</p>
                                </div>
                                <div class="text-right">
                                    <span
                                        class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Programada</span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-gray-500 py-4">
                            Não há aulas programadas para hoje.
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Ações Rápidas</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <a href="{% url 'teacher_analytics' %}"
                            class="w-full flex items-center justify-center px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                            <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                            Análise Detalhada
                        </a>
                    </div>
                </div>

                <!-- System Alerts -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="alert-circle" class="h-5 w-5 mr-2 text-red-500"></i>
                            Alertas do Sistema
                        </h3>
                    </div>
                    <div class="p-6 space-y-3" id="systemAlerts">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <i data-lucide="info" class="h-4 w-4 text-blue-500 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-blue-800 text-sm">Sistema Atualizado</p>
                                    <p class="text-xs text-blue-600">Todas as funcionalidades estão operacionais</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Django data injection -->
    <script id="django-data" type="application/json">
    {
        "initialCodeDetails": {{ initial_code_details_json|default:"{}"|safe }},
        "initialStudentSubmissions": {{ initial_student_submissions_json|default:"[]"|safe }},
        "activeClassSessionIdInitial": "{{ active_class_session_id_initial|default:""|safe }}",
        "userRole": "teacher",
        "csrfToken": "{{ csrf_token|safe }}",
        "isAuthenticated": {{ request.user.is_authenticated|yesno:"true,false" }},
        "apiUrls": {
            "generateCode": "{% url 'generate_code_api_view' %}",
            "runAiValidation": "{% url 'run_ai_validation' %}",
            "validateAttendance": "{% url 'validate_attendance' %}",
            "getSessionSubmissions": "{% url 'get_session_submissions' %}"
        }
    }
    </script>

    <script>
        // Initialize Lucide icons ONCE
        document.addEventListener('DOMContentLoaded', function () {
            lucide.createIcons();
        });

        // Parse Django data safely
        let djangoData;
        try {
            djangoData = JSON.parse(document.getElementById('django-data').textContent);
        } catch (e) {
            console.error('Error parsing Django data:', e);
            djangoData = {
                initialCodeDetails: {},
                initialStudentSubmissions: [],
                activeClassSessionIdInitial: "",
                userRole: "teacher",
                csrfToken: "",
                isAuthenticated: false,
                apiUrls: {}
            };
        }

        // Global variables
        let attendanceSocket = null;
        let currentClassSessionId = null;
        let codeTimerInterval = null;
        let codeExpiryTimestamp = null;
        let currentSubmissions = [];
        let currentFilter = 'all';
        let activeCodeExists = false; // Track if there's an active code

        // Extract data from Django
        const initialCodeDetails = djangoData.initialCodeDetails || {};
        const initialStudentSubmissions = djangoData.initialStudentSubmissions || [];
        const activeClassSessionIdInitial = djangoData.activeClassSessionIdInitial || "";
        const CSRF_TOKEN = djangoData.csrfToken || "";
        const API_URLS = djangoData.apiUrls || {};

        // ===== NOTIFICATION SYSTEM =====

        function updateNotificationCount(pendingCount) {
            const notificationCountEl = document.getElementById('notificationCount');
            const notificationBtn = document.getElementById('notificationBtn');

            if (notificationCountEl && notificationBtn) {
                notificationCountEl.textContent = pendingCount;

                if (pendingCount > 0) {
                    // Show notification badge and make it visible
                    notificationCountEl.style.display = 'flex';
                    notificationCountEl.className = 'absolute -top-1 -right-1 bg-red-500 text-xs rounded-full h-5 w-5 flex items-center justify-center text-white animate-pulse';

                    // Add visual indication to the bell icon
                    notificationBtn.className = 'text-white hover:text-gray-300 relative animate-pulse';
                } else {
                    // Hide notification badge when no pending submissions
                    notificationCountEl.style.display = 'none';
                    notificationBtn.className = 'text-white hover:text-gray-300 relative';
                }
            }
        }

        function scrollToSubmissions() {
            const submissionsSection = document.getElementById('submissionsSection');
            if (submissionsSection) {
                submissionsSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // Add a brief highlight effect to draw attention
                submissionsSection.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                setTimeout(() => {
                    submissionsSection.style.boxShadow = '';
                }, 2000);
            }
        }

        // ===== STATUS MANAGEMENT =====

        function resetCodeStatus() {
            const statusIndicator = document.getElementById('codeStatusIndicator');
            const activeCodeDisplay = document.getElementById('activeCodeDisplay');
            const deactivateBtn = document.getElementById('deactivateBtn');

            if (statusIndicator) {
                statusIndicator.innerHTML = `
                    <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                    <span class="text-sm text-gray-500">Sem código ativo</span>
                `;
            }

            if (activeCodeDisplay) activeCodeDisplay.style.display = 'none';
            if (deactivateBtn) deactivateBtn.style.display = 'none';

            document.getElementById('activeCodesCount').textContent = '0';
            activeCodeExists = false;

            // Reset notification count when resetting code status
            updateNotificationCount(0);

            if (codeTimerInterval) {
                clearInterval(codeTimerInterval);
                codeTimerInterval = null;
            }
        }

        function resetActiveSessionIndicator() {
            const indicator = document.getElementById('activeSessionIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // ===== MAIN FUNCTIONS =====

        function generateNewCode() {
            const sessionSelect = document.getElementById('classSessionSelect');
            const classSessionId = sessionSelect ? sessionSelect.value : '';

            if (!classSessionId) {
                alert('Selecione uma sessão de aula.');
                return;
            }

            const generateBtn = document.getElementById('generateCodeBtn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Gerando...';
            }

            fetch(API_URLS.generateCode, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: new URLSearchParams({
                    'class_session_id': classSessionId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateCodeDisplay(data.code, data.expires_at);
                        updateActiveSessionIndicator(sessionSelect.options[sessionSelect.selectedIndex].dataset.courseName);
                        activeCodeExists = true; // Mark that we have an active code
                        alert('Código gerado com sucesso!');
                        loadSubmissionsForSession(classSessionId);
                    } else {
                        alert('Erro ao gerar código: ' + (data.message || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro ao gerar o código.');
                })
                .finally(() => {
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'Gerar Novo Código';
                    }
                });
        }

        function updateCodeDisplay(code, expiresAtISO) {
            const codeDisplay = document.getElementById('currentCode');
            const activeCodeDisplay = document.getElementById('activeCodeDisplay');
            const statusIndicator = document.getElementById('codeStatusIndicator');
            const deactivateBtn = document.getElementById('deactivateBtn');

            if (codeDisplay && activeCodeDisplay) {
                codeDisplay.textContent = code;
                activeCodeDisplay.style.display = 'block';

                if (statusIndicator) {
                    statusIndicator.innerHTML = `
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-green-600">Código ativo</span>
                    `;
                }

                if (deactivateBtn) deactivateBtn.style.display = 'inline-block';

                codeExpiryTimestamp = new Date(expiresAtISO).getTime();
                startCodeTimer();

                document.getElementById('activeCodesCount').textContent = '1';
                activeCodeExists = true; // Mark that we have an active code
            }
        }

        function startCodeTimer() {
            if (codeTimerInterval) clearInterval(codeTimerInterval);

            codeTimerInterval = setInterval(function () {
                const now = new Date().getTime();
                const timeLeft = codeExpiryTimestamp - now;
                const timerElement = document.getElementById('timeRemaining');

                if (timeLeft <= 0) {
                    clearInterval(codeTimerInterval);
                    if (timerElement) timerElement.textContent = 'Código Expirado';

                    // Reset status when code expires
                    const statusIndicator = document.getElementById('codeStatusIndicator');
                    if (statusIndicator) {
                        statusIndicator.innerHTML = `
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-red-600">Código expirado</span>
                        `;
                    }

                    document.getElementById('activeCodesCount').textContent = '0';
                    activeCodeExists = false;
                    updateNotificationCount(0); // Reset notifications when code expires
                    return;
                }

                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                if (timerElement) {
                    timerElement.textContent = 'Expira em: ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }
            }, 1000);
        }

        function copyCodeToClipboard() {
            const codeElement = document.getElementById('currentCode');
            if (codeElement) {
                navigator.clipboard.writeText(codeElement.textContent).then(() => {
                    alert('Código copiado para a área de transferência!');
                }).catch(err => {
                    console.error('Falha ao copiar:', err);
                });
            }
        }

        function deactivateCode() {
            resetCodeStatus();
            resetActiveSessionIndicator();
        }

        function updateActiveSessionIndicator(courseName) {
            const indicator = document.getElementById('activeSessionIndicator');
            const sessionName = document.getElementById('activeSessionName');

            if (indicator && sessionName) {
                sessionName.textContent = courseName;
                indicator.style.display = 'block';
            }
        }

        function loadSubmissionsForSession(sessionId) {
            const submissionsList = document.getElementById('submissionsList');
            if (!submissionsList) return;

            submissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">Carregando envios...</div>';
            currentClassSessionId = sessionId;

            if (!API_URLS.getSessionSubmissions) {
                submissionsList.innerHTML = '<div class="text-center text-red-500 py-4">URL da API não disponível</div>';
                return;
            }

            fetch(API_URLS.getSessionSubmissions + '?class_session_id=' + sessionId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentSubmissions = data.submissions || [];
                        renderSubmissions();
                        updateSubmissionCounts();
                    } else {
                        submissionsList.innerHTML = '<div class="text-center text-red-500 py-4">Erro ao carregar envios</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    submissionsList.innerHTML = '<div class="text-center text-red-500 py-4">Falha ao pesquisar envios</div>';
                });
        }

        function renderSubmissions() {
            const submissionsList = document.getElementById('submissionsList');
            if (!submissionsList) return;

            if (currentSubmissions.length === 0) {
                submissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhuma submissão encontrada.</div>';
                return;
            }

            submissionsList.innerHTML = '';

            // Limit submissions to avoid infinite scroll
            const maxSubmissions = 50;
            const submissionsToShow = currentSubmissions.slice(0, maxSubmissions);

            submissionsToShow.forEach(submission => {
                const submissionElement = createSubmissionElement(submission);
                submissionsList.appendChild(submissionElement);
            });

            if (currentSubmissions.length > maxSubmissions) {
                const moreElement = document.createElement('div');
                moreElement.className = 'text-center text-gray-500 py-4';
                moreElement.textContent = `... e mais ${currentSubmissions.length - maxSubmissions} submissões`;
                submissionsList.appendChild(moreElement);
            }
        }

        function createSubmissionElement(submission) {
            const div = document.createElement('div');
            let statusText = 'Pendente';
            let bgClass = 'bg-yellow-50 border-yellow-200';

            if (submission.is_present) {
                statusText = 'Presente';
                bgClass = 'bg-green-50 border-green-200';
            } else if (submission.aiResult && submission.aiResult.isFraudulent) {
                statusText = 'Suspeito';
                bgClass = 'bg-red-50 border-red-200';
            }

            div.className = `flex items-center justify-between p-4 border ${bgClass} rounded-lg`;
            div.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center border">
                        <span class="font-semibold text-sm">${submission.name ? submission.name.substring(0, 2).toUpperCase() : 'UN'}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">${submission.name || 'Nome Desconhecido'}</p>
                        <p class="text-sm text-gray-500">Submetido • IP: ${submission.simulatedIp || '--'}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(submission)}">${statusText}</span>
                    ${!submission.is_present ? `
                        <button class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors" onclick="validateAttendance('${submission.id}')">
                            Validar
                        </button>
                    ` : ''}
                </div>
            `;

            return div;
        }

        function getStatusBadgeClass(submission) {
            if (submission.is_present) return 'bg-green-100 text-green-800';
            if (submission.aiResult && submission.aiResult.isFraudulent) return 'bg-red-100 text-red-800';
            return 'bg-yellow-100 text-yellow-800';
        }

        function updateSubmissionCounts() {
            const all = currentSubmissions.length;
            const pending = currentSubmissions.filter(s => !s.is_present).length;
            const validated = currentSubmissions.filter(s => s.is_present).length;
            const suspicious = currentSubmissions.filter(s => s.aiResult && s.aiResult.isFraudulent).length;

            document.getElementById('allCount').textContent = all;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('validatedCount').textContent = validated;
            document.getElementById('suspiciousCount').textContent = suspicious;
            document.getElementById('pendingSubmissions').textContent = pending;
            document.getElementById('submissionCount').textContent = all + ' submissões';

            // Update notification count with pending submissions
            updateNotificationCount(pending);

            if (all > 0) {
                const rate = Math.round((validated / all) * 100);
                document.getElementById('todayAttendanceRate').textContent = rate + '%';
                document.getElementById('todayAttendanceText').textContent = validated + '/' + all + ' alunos presentes';
            }
        }

        function validateAttendance(recordId) {
            if (!API_URLS.validateAttendance) {
                alert('URL da API não disponível.');
                return;
            }

            fetch(API_URLS.validateAttendance, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: new URLSearchParams({
                    'attendance_record_id': recordId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const submissionIndex = currentSubmissions.findIndex(s => s.id === recordId);
                        if (submissionIndex !== -1) {
                            currentSubmissions[submissionIndex].is_present = true;
                            renderSubmissions();
                            updateSubmissionCounts();
                        }
                        alert('Presença validada com sucesso!');
                    } else {
                        alert('Erro ao validar presença: ' + (data.message || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro durante a validação.');
                });
        }

        function validateAllPending() {
            const pendingSubmissions = currentSubmissions.filter(s => !s.is_present);
            if (pendingSubmissions.length === 0) {
                alert('Não há submissões pendentes para validar.');
                return;
            }

            if (confirm(`Validar todas as ${pendingSubmissions.length} submissões pendentes?`)) {
                // Validate each pending submission
                let validatedCount = 0;
                const totalPending = pendingSubmissions.length;

                pendingSubmissions.forEach((submission, index) => {
                    setTimeout(() => {
                        fetch(API_URLS.validateAttendance, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': CSRF_TOKEN
                            },
                            body: new URLSearchParams({
                                'attendance_record_id': submission.id
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    const submissionIndex = currentSubmissions.findIndex(s => s.id === submission.id);
                                    if (submissionIndex !== -1) {
                                        currentSubmissions[submissionIndex].is_present = true;
                                    }
                                    validatedCount++;

                                    // Update UI after each validation
                                    renderSubmissions();
                                    updateSubmissionCounts();

                                    // Show completion message after all validations
                                    if (validatedCount === totalPending) {
                                        alert(`Todas as ${totalPending} submissões foram validadas com sucesso!`);
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Erro na validação:', error);
                            });
                    }, index * 200); // Stagger requests to avoid overwhelming the server
                });
            }
        }

        // Filter functionality
        function initializeFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    filterButtons.forEach(b => {
                        b.classList.remove('bg-accent', 'text-white');
                        b.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    });

                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    btn.classList.add('bg-accent', 'text-white');

                    currentFilter = btn.dataset.filter;
                    renderSubmissions();
                });
            });
        }

        // Session selection change handler
        function setupSessionSelector() {
            const sessionSelect = document.getElementById('classSessionSelect');
            if (sessionSelect) {
                sessionSelect.addEventListener('change', function (e) {
                    const selectedSessionId = e.target.value;

                    // Reset code status when changing sessions (unless we have an active code for current session)
                    if (!activeCodeExists) {
                        resetCodeStatus();
                        resetActiveSessionIndicator();
                    }

                    if (selectedSessionId) {
                        loadSubmissionsForSession(selectedSessionId);

                        // Only show active session if we don't have an active code
                        if (!activeCodeExists) {
                            const selectedOption = e.target.options[e.target.selectedIndex];
                            const courseName = selectedOption.dataset.courseName;
                            // Don't show as active unless there's actually an active code
                            // updateActiveSessionIndicator(courseName);
                        }
                    }
                });
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Dashboard do Professor inicializado');

            // Initialize UI components
            initializeFilters();
            setupSessionSelector();

            // Reset status on page load (ensure clean state)
            resetCodeStatus();
            resetActiveSessionIndicator();

            // Initialize notification count
            updateNotificationCount(0);

            // Load initial data if available
            if (initialCodeDetails && initialCodeDetails.code) {
                updateCodeDisplay(initialCodeDetails.code, initialCodeDetails.expires_at);
                activeCodeExists = true;
            }

            if (initialStudentSubmissions && initialStudentSubmissions.length > 0) {
                currentSubmissions = initialStudentSubmissions;
                renderSubmissions();
                updateSubmissionCounts();
            }

            if (activeClassSessionIdInitial && activeClassSessionIdInitial !== 'null') {
                console.log('Auto-connecting WebSocket for session:', activeClassSessionIdInitial);
                initWebSocket(activeClassSessionIdInitial);
            }
            const sessionSelect = document.getElementById('classSessionSelect');
            if (sessionSelect) {
                sessionSelect.addEventListener('change', function (e) {
                    if (e.target.value) {
                        console.log('Connecting WebSocket for new session:', e.target.value);
                        initWebSocket(e.target.value);
                    }
                });
            }

        // Initialize icons ONCE at the end
        lucide.createIcons();
        });
    </script>

    <!-- Logout Form -->
    <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
        {% csrf_token %}
    </form>

    <script>
        function logoutConfirm() {
            if (confirm('Tem a certeza de que quer sair?')) {
                document.getElementById('logout-form').submit();
            }
        }
    </script>
</body>
{% endblock %}